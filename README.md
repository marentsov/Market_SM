# Market SM

Админка Django для управления торговыми павильонами и отслеживания подозрительных объектов.

## Описание

Система предназначена для учета торговых павильонов, арендаторов, договоров аренды и счетчиков электроэнергии. Основная функция — выявление подозрительных павильонов по критерию отсутствия договора при наличии потребления электроэнергии.

## Основные функции

### Управление данными

- **Павильоны**: учет павильонов с привязкой к зданиям, статусами (свободен, арендован, забронирован, на ремонте), площадью, характеристиками (теги)
- **Арендаторы**: учет арендаторов с ИНН, контактами
- **Договоры**: хранение договоров аренды с привязкой к павильонам
- **Счетчики электроэнергии**: учет счетчиков с показаниями и расчетом потребления

### Импорт данных

- **Импорт павильонов**: загрузка из Excel (лист "все павильоны 1с", колонка "Объект")
- **Импорт договоров и арендаторов**: загрузка из Excel (лист "актуальные арендаторы", колонки: Контрагент, ИНН, Договор, Объект)
- **Импорт счетчиков**: загрузка показаний счетчиков из Excel (листы с названием "показания ДД.ММ.ГГГГ")

### Нормализация имен павильонов

При импорте используется нормализация названий павильонов для сопоставления с существующими записями:

- Удаление скобок и дополнительной информации: `Г21/1 (2 этаж)` → `Г21/1`
- Удаление суффиксов: `Е11/1 5квт` → `Е11/1`
- Разворачивание диапазонов: `Е10/1,2` → `['Е10/1', 'Е10/2']`
- Обработка множественных павильонов через запятую или пробел: `Г9/1, Д10/1, Д12/1` → `['Г9/1', 'Д10/1', 'Д12/1']`
- Обработка префиксов: `Е10/1,2,3` → `['Е10/1', 'Е10/2', 'Е10/3']`
- Поиск с учетом вариантов без пробелов

### Выявление подозрительных павильонов

Фильтр в админке выявляет павильоны, которые:
- Не имеют привязанного арендатора (`tenant` = NULL)
- Имеют потребление электроэнергии более 1 кВт·ч по счетчикам

Такие павильоны требуют проверки на наличие незарегистрированных договоров или неучтенного потребления.

## Технологии

- Django 5.2
- Python 3.13
- SQLite (по умолчанию)
- pandas, openpyxl (для импорта Excel)

## Структура проекта

```
Market_SM/
├── apps/
│   └── pavilions/
│       ├── models.py              # Модели: Building, Pavilion, Tenant, Contract, ElectricityMeter, ElectricityReading
│       ├── admin.py               # Админка Django с кастомными фильтрами и импортами
│       └── services/
│           ├── excel_import.py                    # Импорт павильонов
│           ├── contracts_importer.py             # Импорт договоров и арендаторов
│           ├── meter_importer.py                 # Импорт счетчиков и показаний
│           └── pavilion_name_normalizer.py       # Нормализация имен павильонов
├── config/
│   ├── settings.py                # Настройки Django
│   └── urls.py                    # URL-конфигурация
└── templates/admin/               # Шаблоны для админки
```

## Установка

1. Установить зависимости:
```bash
pip install -r requirements.txt
```

2. Выполнить миграции:
```bash
python manage.py migrate
```

3. Создать суперпользователя:
```bash
python manage.py createsuperuser
```

4. Запустить сервер разработки:
```bash
python manage.py runserver
```

## Использование

Доступ к админке: `http://localhost:8000/admin/`

### Импорт данных

1. **Импорт павильонов**: Админка → Павильоны → "Импорт Excel"
2. **Импорт договоров**: Админка → Павильоны → "Импорт договоров"
3. **Импорт счетчиков**: Админка → Счетчики электроэнергии → "Импорт счетчиков"

### Фильтрация подозрительных павильонов

Админка → Павильоны → Фильтр "Подозрительные (нет договора, но есть расход по счетчику)" → "Да"

## Модели данных

- **Building**: здание/рынок/территория
- **Pavilion**: торговый павильон (связь с Building, Tenant, Contract)
- **Tenant**: арендатор (ИНН, контакты)
- **Contract**: договор аренды
- **ElectricityMeter**: счетчик электроэнергии (M2M с Pavilion)
- **ElectricityReading**: показания счетчика (автоматический расчет потребления)

